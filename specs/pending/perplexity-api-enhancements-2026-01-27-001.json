{
  "spec_id": "perplexity-api-enhancements-2026-01-27-001",
  "title": "perplexity-api-enhancements",
  "generated": "2026-01-27T11:45:40.635437Z",
  "last_updated": "2026-01-27T11:57:02.289036Z",
  "metadata": {
    "description": "",
    "mission": "Enhance the Perplexity search provider with additional configurable parameters (search_context_size, max_tokens, date filters), following patterns established by the Tavily provider enhancement.",
    "objectives": [],
    "complexity": "low",
    "estimated_hours": 0,
    "assumptions": [
      "Perplexity Search API endpoints remain stable",
      "Date format %m/%d/%Y is acceptable (matches Perplexity API)",
      "Default search_context_size='medium' provides reasonable cost/quality balance"
    ],
    "owner": "",
    "category": "implementation",
    "template": "empty"
  },
  "progress_percentage": 0,
  "status": "pending",
  "current_phase": null,
  "hierarchy": {
    "spec-root": {
      "type": "spec",
      "title": "perplexity-api-enhancements",
      "status": "pending",
      "parent": null,
      "children": [
        "phase-1",
        "phase-2",
        "phase-3",
        "phase-4"
      ],
      "total_tasks": 21,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-1": {
      "type": "phase",
      "title": "Enhanced Search Parameters",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-1-1",
        "task-1-2",
        "task-1-3",
        "task-1-4",
        "task-1-5",
        "task-1-6",
        "verify-1-1"
      ],
      "total_tasks": 7,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Add configurable parameters to existing Perplexity search provider"
      },
      "dependencies": {
        "blocks": [
          "phase-2"
        ],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-1": {
      "type": "task",
      "title": "Add validation constants",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add VALID_SEARCH_CONTEXT_SIZES frozenset constant",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py",
        "acceptance_criteria": [
          "VALID_SEARCH_CONTEXT_SIZES = frozenset(['low', 'medium', 'high']) defined at module level"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-2": {
      "type": "task",
      "title": "Add _validate_search_params function",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add validation function for search parameters following Tavily pattern. Validates search_context_size, max_tokens, date formats, date range logic, and recency_filter exclusivity.",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py",
        "acceptance_criteria": [
          "Function raises ValueError for invalid search_context_size",
          "Function raises ValueError for non-positive max_tokens",
          "Function validates date format as %m/%d/%Y",
          "Function validates search_after_date < search_before_date",
          "Function raises error when recency_filter combined with date filters"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-3": {
      "type": "task",
      "title": "Extract new parameters in search method",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update search() method to extract new kwargs: search_context_size (default 'medium'), max_tokens (default 50000), max_tokens_per_page (default 2048), search_after_date, search_before_date",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py",
        "acceptance_criteria": [
          "All 5 new parameters extracted from kwargs",
          "Default values match current behavior",
          "Backward compatible with existing callers"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-4": {
      "type": "task",
      "title": "Update payload construction",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update API request payload to include new parameters when provided",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py",
        "acceptance_criteria": [
          "search_context_size included in payload",
          "max_tokens uses configurable value instead of hard-coded 50000",
          "max_tokens_per_page uses configurable value instead of hard-coded 2048",
          "Date filters included when provided"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-5": {
      "type": "task",
      "title": "Update docstrings",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update search() method docstring to document all new parameters and the domain filter '-' prefix for exclusion",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py",
        "acceptance_criteria": [
          "All new parameters documented in kwargs section",
          "Domain filter exclusion with '-' prefix documented",
          "Date format %m/%d/%Y documented"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-2": {
      "type": "phase",
      "title": "Configuration Support",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-2-1",
        "task-2-2",
        "task-2-3",
        "verify-2-1"
      ],
      "total_tasks": 4,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Add configurable Perplexity settings to ResearchConfig"
      },
      "dependencies": {
        "blocks": [
          "phase-3"
        ],
        "blocked_by": [
          "phase-1"
        ],
        "depends": []
      }
    },
    "task-2-1": {
      "type": "task",
      "title": "Add Perplexity config fields to ResearchConfig",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add 5 new fields to ResearchConfig dataclass following tavily_ prefix pattern: perplexity_search_context_size, perplexity_max_tokens, perplexity_max_tokens_per_page, perplexity_recency_filter, perplexity_country",
        "file_path": "src/foundry_mcp/config.py",
        "acceptance_criteria": [
          "All 5 fields added with correct types and defaults",
          "Fields documented in class docstring",
          "Follows tavily_ naming pattern"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-2": {
      "type": "task",
      "title": "Update from_toml_dict parsing",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update ResearchConfig.from_toml_dict() to parse new Perplexity fields from TOML",
        "file_path": "src/foundry_mcp/config.py",
        "acceptance_criteria": [
          "All 5 fields parsed from TOML dict",
          "Type conversion applied correctly",
          "Missing values use defaults"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-2-3": {
      "type": "task",
      "title": "Add _validate_perplexity_config method",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add validation method for Perplexity config fields following _validate_tavily_config pattern. Call from __post_init__.",
        "file_path": "src/foundry_mcp/config.py",
        "acceptance_criteria": [
          "search_context_size validated against low/medium/high",
          "max_tokens validated as positive integer",
          "recency_filter validated against day/week/month/year/None",
          "country validated as ISO 3166-1 alpha-2 or None",
          "Clear error messages on validation failure"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-3": {
      "type": "phase",
      "title": "Deep Research Integration",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-3-1",
        "task-3-2",
        "verify-3-1"
      ],
      "total_tasks": 3,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Pass Perplexity config to the search provider in deep research workflow"
      },
      "dependencies": {
        "blocks": [
          "phase-4"
        ],
        "blocked_by": [
          "phase-2"
        ],
        "depends": []
      }
    },
    "task-3-1": {
      "type": "task",
      "title": "Add _get_perplexity_search_kwargs helper",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add _get_perplexity_search_kwargs(state: DeepResearchState) -> dict[str, Any] method following the _get_tavily_search_kwargs pattern at line 1060. Read config via self.config.research to access perplexity_* fields.",
        "file_path": "src/foundry_mcp/core/research/workflows/deep_research.py",
        "acceptance_criteria": [
          "Method returns dict with search_context_size, max_tokens, max_tokens_per_page, country, recency_filter",
          "Only includes non-None values",
          "Follows same structure as _get_tavily_search_kwargs"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-3-2": {
      "type": "task",
      "title": "Update provider selection logic",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Update the provider selection logic around line 2755 to call _get_perplexity_search_kwargs() when provider_name == 'perplexity'",
        "file_path": "src/foundry_mcp/core/research/workflows/deep_research.py",
        "acceptance_criteria": [
          "Perplexity kwargs merged into search_kwargs when provider is perplexity",
          "include_raw_content still set correctly",
          "Other providers unaffected"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "phase-4": {
      "type": "phase",
      "title": "Testing",
      "status": "pending",
      "parent": "spec-root",
      "children": [
        "task-4-1",
        "task-4-2",
        "task-4-3",
        "task-4-4",
        "task-4-5",
        "verify-4-1",
        "task-4-6"
      ],
      "total_tasks": 7,
      "completed_tasks": 0,
      "metadata": {
        "purpose": "",
        "description": "Comprehensive test coverage for all changes"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [
          "phase-3"
        ],
        "depends": []
      }
    },
    "task-4-1": {
      "type": "task",
      "title": "Create Perplexity config test file",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create new test file following tests/unit/test_config_tavily.py pattern with test classes: TestPerplexityConfigParsing, TestPerplexityConfigDefaults, TestPerplexityConfigValidation",
        "file_path": "tests/unit/test_config_perplexity.py",
        "acceptance_criteria": [
          "Test file created with proper structure",
          "Tests TOML parsing for all 5 fields",
          "Tests default value preservation",
          "Tests validation errors for invalid values"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-2": {
      "type": "task",
      "title": "Add search_context_size parameter tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add tests for search_context_size parameter in payload construction",
        "file_path": "tests/core/research/providers/test_perplexity.py",
        "acceptance_criteria": [
          "Test default value 'medium' used when not specified",
          "Test all valid values: low, medium, high",
          "Test invalid value raises ValueError"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-3": {
      "type": "task",
      "title": "Add max_tokens override tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add tests for configurable max_tokens and max_tokens_per_page",
        "file_path": "tests/core/research/providers/test_perplexity.py",
        "acceptance_criteria": [
          "Test custom max_tokens included in payload",
          "Test custom max_tokens_per_page included in payload",
          "Test defaults used when not specified"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-4": {
      "type": "task",
      "title": "Add date filter tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add tests for date filter parameters and validation",
        "file_path": "tests/core/research/providers/test_perplexity.py",
        "acceptance_criteria": [
          "Test valid date format accepted",
          "Test invalid date format raises ValueError",
          "Test date range validation (after < before)",
          "Test recency_filter exclusivity with date filters"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-5": {
      "type": "task",
      "title": "Create Perplexity response fixtures",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Create fixture file following tests/fixtures/tavily_responses.py pattern with mock responses for new parameter scenarios",
        "file_path": "tests/fixtures/perplexity_responses.py",
        "acceptance_criteria": [
          "Mock responses for basic search",
          "Mock responses with new parameters",
          "FIXTURE_METADATA with version and freshness tracking"
        ],
        "task_category": "implementation"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-4-1": {
      "type": "verify",
      "title": "Run all Perplexity tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Verify all tests pass",
        "verification_type": "run-tests"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-1-6": {
      "type": "task",
      "title": "Add last_updated date filter parameters",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add last_updated_after_filter and last_updated_before_filter parameters to search() method. These filter by content modification date rather than publication date.",
        "file_path": "src/foundry_mcp/core/research/providers/perplexity.py"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-1-1": {
      "type": "verify",
      "title": "Phase 1 fidelity review",
      "status": "pending",
      "parent": "phase-1",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Review implementation against spec requirements for Phase 1. Verify all parameters added, validation working, payload construction correct.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-2-1": {
      "type": "verify",
      "title": "Phase 2 fidelity review",
      "status": "pending",
      "parent": "phase-2",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Review implementation against spec requirements for Phase 2. Verify config fields, TOML parsing, and validation working correctly.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "verify-3-1": {
      "type": "verify",
      "title": "Phase 3 fidelity review",
      "status": "pending",
      "parent": "phase-3",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Review implementation against spec requirements for Phase 3. Verify deep research integration passes Perplexity config correctly.",
        "verification_type": "fidelity"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    },
    "task-4-6": {
      "type": "task",
      "title": "Add last_updated filter tests",
      "status": "pending",
      "parent": "phase-4",
      "children": [],
      "total_tasks": 1,
      "completed_tasks": 0,
      "metadata": {
        "description": "Add tests for last_updated_after_filter and last_updated_before_filter parameters",
        "file_path": "tests/core/research/providers/test_perplexity.py"
      },
      "dependencies": {
        "blocks": [],
        "blocked_by": [],
        "depends": []
      }
    }
  },
  "journal": []
}